import {
  UseGuards,
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  HttpCode,
  HttpStatus,
  ParseIntPipe,
} from '@nestjs/common';

import { AdminAuthDecorator } from '../../decorators/adminAuth.decorator';
import { PermissionDecorator } from '../../decorators/permission.decorator';
import { AdminAuthGuard } from '../../guards/adminAuth.guard';
import { GlobalService } from '../../utils/global/global.service';
import { <%= className %>Service } from './<%= fileName %>.service';
import { <%= relatedEntityClass %> } from '../<%= relatedEntityFileName %>/entities/<%= relatedEntityFileName %>.entity';
import { <%= className %> } from './entities/<%= fileName %>.entity';
import { <%= fileName %>PermissionConstant } from './constants/permission.constant';
import {
  ControllerResDto,
  ServiceResDto,
} from '../../utils/global/dto/global.dto';
import {
  <%= className %>BodyReqDto,
  <%= className %>ParamReqDto,
  <%= className %>BodyUpdateReqDto,
  Delete<%= className %>BodyReqDto,
} from './dto/<%= fileName %>.dto';

@Controller({ path: 'admin/<%= fileNamePlural %>', version: '1' })
@UseGuards(AdminAuthGuard)
export class <%= className %>Controller {
  constructor(
    private globalService: GlobalService,
    private <%= camelName %>Service: <%= className %>Service,
  ) {}

  @Get()
  @HttpCode(HttpStatus.OK)
  
  async findMany(
    @Query('page', ParseIntPipe) page: number,
    @Query('limit', ParseIntPipe) limit: number,
  ): Promise<ControllerResDto<<%= className %>[]>> {
    const { data, pagination }: ServiceResDto<<%= className %>[]> =
      await this.<%= camelName %>Service.findMany(null, page, limit);
    return this.globalService.setControllerResponse(data, null, pagination);
  }

  @Post()
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_CREATE)
  async create(
    @AdminAuthDecorator() adminAuth: any,
    @Body() bodyReq: <%= className %>BodyReqDto<<%= relatedEntityClass %>>,
  ): Promise<ControllerResDto<<%= className %>>> {
    const result = await this.<%= camelName %>Service.create(bodyReq, adminAuth);
    return this.globalService.setControllerResponse(result, '<%= className %> created successfully.');
  }

  @Get(':id')
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_FIND_ONE)
  async findOne(@Param() paramReqDto: <%= className %>ParamReqDto): Promise<ControllerResDto<<%= className %>>> {
    const result = await this.<%= camelName %>Service.findOne(paramReqDto.id);
    return this.globalService.setControllerResponse(result);
  }

  @Put(':id')
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_UPDATE)
  async update(
    @AdminAuthDecorator() adminAuth: any,
    @Param() paramReqDto: <%= className %>ParamReqDto,
    @Body() bodyReq: <%= className %>BodyUpdateReqDto<<%= relatedEntityClass %>>,
  ): Promise<ControllerResDto<<%= className %>>> {
    const result = await this.<%= camelName %>Service.update(bodyReq, paramReqDto.id, adminAuth);
    return this.globalService.setControllerResponse(result, '<%= className %> updated successfully.');
  }

  @Delete(':id/permanent')
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_HARD_DELETE)
  async hardDelete(@Param() paramReqDto: <%= className %>ParamReqDto): Promise<ControllerResDto<{ isDeleted: boolean }>> {
    const isDeleted = await this.<%= camelName %>Service.delete(paramReqDto.id);
    return this.globalService.setControllerResponse({ isDeleted }, '<%= className %> deleted successfully.');
  }

  @Delete(':id')
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_SOFT_DELETE)
  async softDelete(
    @AdminAuthDecorator() adminAuth: any,
    @Param() paramReqDto: <%= className %>ParamReqDto,
  ): Promise<ControllerResDto<{ isDeleted: boolean }>> {
    const bodyReq: Delete<%= className %>BodyReqDto = { hasSoftDeleted: true };
    const result = await this.<%= camelName %>Service.update(bodyReq, paramReqDto.id, adminAuth);
    return this.globalService.setControllerResponse({ isDeleted: !!result }, '<%= className %> deleted successfully.');
  }

  @Put(':id/rollback')
  @HttpCode(HttpStatus.OK)
  @PermissionDecorator(<%= fileName %>PermissionConstant.ADMIN_<%= constantName %>_ROLLBACK)
  async rollback(
    @AdminAuthDecorator() adminAuth: any,
    @Param() paramReqDto: <%= className %>ParamReqDto,
  ): Promise<ControllerResDto<<%= className %>>> {
    const bodyReq: Delete<%= className %>BodyReqDto = { hasSoftDeleted: false };
    const result = await this.<%= camelName %>Service.update(bodyReq, paramReqDto.id, adminAuth, true);
    return this.globalService.setControllerResponse(result, '<%= className %> rollback successful.');
  }
}
